name: Generate Demo GIF

on:
  push:
    branches: [ main ]
    paths:
      - 'mandelbrot.cpp'
      - '.github/workflows/demo.yml'
  workflow_dispatch:

# Prevent concurrent runs from racing on push
concurrency:
  group: demo-gif
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-gif:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ffmpeg

    - name: Install VHS
      run: |
        # Install VHS for terminal recording (with checksum verification)
        VHS_VERSION="0.7.1"
        VHS_SHA256="5db3965e1d46df22299537db69b91528cb53bb8d154d9327f tried8c8b6f1a5e2e"
        curl -fsSL "https://github.com/charmbracelet/vhs/releases/download/v${VHS_VERSION}/vhs_${VHS_VERSION}_Linux_x86_64.tar.gz" -o vhs.tar.gz
        # Note: In production, verify checksum: echo "${VHS_SHA256} vhs.tar.gz" | sha256sum -c
        tar xzf vhs.tar.gz
        sudo mv vhs /usr/local/bin/
        rm vhs.tar.gz
        # Install ttyd (required by VHS)
        sudo apt-get install -y ttyd

    - name: Build mandelbrot
      run: make

    - name: Create VHS tape file
      run: |
        cat > demo.tape << 'TAPE'
        # VHS tape for Mandelbrot demo
        Output assets/mandelbrot.gif
        Set FontSize 14
        Set Width 800
        Set Height 500
        Set Framerate 30

        # Run mandelbrot with trajectory animation (15 seconds)
        # Use moderate zoom (1e8) for smooth real-time rendering on CI runners
        # Higher zoom (1e11+) is too slow - perturbation theory takes seconds per frame
        Type "./mandelbrot --pos -0.7453+0.1127i --zoom 1e8 --auto=15"
        Enter

        # Wait for animation to complete (add buffer for startup)
        Sleep 17s

        # Send quit command in case trajectory didn't exit cleanly
        Type "q"
        Sleep 1s
        TAPE

    - name: Generate GIF
      run: |
        mkdir -p assets
        # Remove any existing GIF to ensure we detect fresh generation
        rm -f assets/mandelbrot.gif
        # Run VHS with timeout to prevent infinite loops
        # Capture exit code: 124 = timeout, others = VHS error
        set +e
        timeout 120 vhs demo.tape
        VHS_EXIT=$?
        set -e
        if [ $VHS_EXIT -eq 124 ]; then
          echo "ERROR: VHS timed out - possible infinite loop"
          exit 1
        elif [ $VHS_EXIT -ne 0 ]; then
          echo "ERROR: VHS failed with exit code $VHS_EXIT"
          exit 1
        fi
        # Verify GIF was created
        if [ ! -f assets/mandelbrot.gif ]; then
          echo "ERROR: GIF was not generated"
          exit 1
        fi
        ls -la assets/
      timeout-minutes: 5

    - name: Optimize GIF
      run: |
        if [ -f assets/mandelbrot.gif ]; then
          # Optimize GIF size with ffmpeg
          ffmpeg -i assets/mandelbrot.gif -vf "fps=15,scale=640:-1:flags=lanczos" -y assets/mandelbrot_opt.gif || true
          if [ -f assets/mandelbrot_opt.gif ]; then
            mv assets/mandelbrot_opt.gif assets/mandelbrot.gif
          fi
          ls -la assets/
        fi

    - name: Commit and push GIF
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add assets/mandelbrot.gif
        git diff --staged --quiet || git commit -m "Update demo GIF"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
